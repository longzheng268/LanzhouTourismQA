# 兰州旅游知识问答系统 - 完整使用文档

## 📋 项目概述

**项目名称**：兰州旅游知识问答系统（RAG版）
**技术栈**：Kotlin + Compose Desktop + MIMO API
**架构**：RAG（检索增强生成）
**版本**：1.0.0

## 🎯 项目特点

- ✅ **RAG架构**：结合向量检索和大模型生成
- ✅ **本地知识库**：25条兰州旅游专业知识
- ✅ **智能检索**：基于TF-IDF的向量相似度匹配
- ✅ **现代GUI**：Compose Desktop + Material Design 3
- ✅ **MIMO API**：使用MIMO大模型生成回答
- ✅ **PowerShell支持**：现代化脚本工具

---

## 🚀 快速开始（3步）

### 第1步：配置API密钥（必须）

**文件位置**：`src/main/resources/config.json`

**需要修改的行**：
```json
"api_key": "sk-ch75m7txnh5oiiiq3g3wvadcpz8q7q1qheefl3vqx31rphnv"
```

**操作**：将上面的密钥替换为您自己的MIMO API密钥

### 第2步：构建项目

**PowerShell**（推荐）：
```powershell
.\build.ps1
```

**CMD**：
```cmd
build.bat
```

**如果PowerShell提示权限错误**：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\build.ps1
```

### 第3步：运行程序

**PowerShell**（推荐）：
```powershell
.\run.ps1
```

**CMD**：
```cmd
run.bat
```

**开发模式**（无需构建，直接运行）：
```powershell
.\gradlew.bat run
```

---

## 📁 项目结构

```
LanzhouTourismQA/
├── src/main/kotlin/com/lanzhou/qa/
│   ├── Main.kt                    # 主程序入口
│   ├── model/
│   │   └── Models.kt              # 数据模型
│   ├── config/
│   │   └── ConfigManager.kt       # 配置管理
│   ├── embedding/
│   │   └── EmbeddingModel.kt      # 嵌入模型
│   ├── rag/
│   │   └── RAGRetriever.kt        # RAG检索器
│   ├── api/
│   │   └── MIMOClient.kt          # MIMO API客户端
│   ├── service/
│   │   └── QAService.kt           # 核心服务
│   └── ui/
│       ├── AppTheme.kt            # 主题和字体
│       └── QuestionAnswerScreen.kt# 主界面
├── src/main/resources/
│   ├── config.json                # 配置文件
│   └── knowledge_base.json        # 知识库（25条）
├── build.gradle.kts               # Gradle配置
├── setup.ps1                      # 初始化脚本（PowerShell）
├── build.ps1                      # 构建脚本（PowerShell）
├── run.ps1                        # 运行脚本（PowerShell）
├── setup.bat                      # 初始化脚本（CMD）
├── build.bat                      # 构建脚本（CMD）
├── run.bat                        # 运行脚本（CMD）
└── 使用文档.md                    # 本文件
```

---

## 🔧 详细使用指南

### PowerShell 脚本说明

#### setup.ps1 - 初始化脚本
```powershell
.\setup.ps1
```
功能：
- ✅ 检查Java环境（JDK 17+）
- ✅ 创建Gradle Wrapper
- ✅ 提示配置API密钥
- ✅ 下载项目依赖

#### build.ps1 - 构建脚本
```powershell
.\build.ps1
```
功能：
- ✅ 清理旧文件
- ✅ 构建JAR包
- ✅ 复制配置文件

#### run.ps1 - 运行脚本
```powershell
.\run.ps1
```
功能：
- ✅ 自动检测JAR包
- ✅ 智能选择运行方式
- ✅ 回退到开发模式

### CMD 脚本说明

如果您更习惯使用CMD，也可以使用对应的`.bat`文件：
- `setup.bat` - 初始化
- `build.bat` - 构建
- `run.bat` - 运行

---

## 📚 知识库内容

包含25条兰州旅游专业知识，涵盖9个分类：

| 分类 | 条目数 | 示例 |
|------|--------|------|
| 地理 | 2 | "兰州在哪里？" |
| 景点 | 4 | "兰州有什么著名景点？" |
| 美食 | 5 | "兰州牛肉面有什么特点？" |
| 旅游 | 3 | "兰州的最佳旅游时间？" |
| 交通 | 1 | "如何到达兰州？" |
| 历史 | 3 | "兰州黄河铁桥的历史？" |
| 气候 | 1 | "兰州的气候特点？" |
| 购物 | 1 | "兰州有什么特产？" |
| 文化 | 5 | "兰州的市花是什么？" |

**存储方式**：支持双模式（数据库 + 本地JSON）

**优势**：
- ✅ 无需数据库服务器（JSON模式）
- ✅ 完全离线运行（JSON模式）
- ✅ 启动速度快（JSON模式）
- ✅ 部署简单（JSON模式）
- ✅ 支持MariaDB数据库（数据库模式）
- ✅ 自动回退机制（数据库失败时自动使用JSON）

---

## 🗄️ 数据库双模式说明

本系统支持**数据库模式**和**本地JSON模式**双模式运行，可根据需要灵活切换。

### 模式对比

| 特性 | 本地JSON模式 | 数据库模式 |
|------|--------------|------------|
| 数据来源 | `knowledge_base.json` | MariaDB `qa_pairs`表 |
| 启动速度 | ⭐⭐⭐⭐⭐ 快 | ⭐⭐ 需要连接 |
| 部署复杂度 | ⭐⭐⭐⭐⭐ 极简单 | ⭐⭐ 需要配置 |
| 数据持久化 | ❌ 文件存储 | ✅ 数据库存储 |
| 聊天历史 | ❌ 不保存 | ✅ 自动保存到`chat_history`表 |
| 适用场景 | 个人使用、测试 | 生产环境、多人使用 |

### 如何切换模式

**1. 修改配置文件**：`src/main/resources/config.json`

```json
{
  "database": {
    "enabled": false  // 改为 true 启用数据库模式
  }
}
```

**2. 数据库配置说明**：
```json
{
  "database": {
    "enabled": false,           // 是否启用数据库
    "host": "localhost",        // 数据库地址
    "port": 3306,               // 端口
    "database": "qa_database",  // 数据库名
    "username": "root",         // 用户名
    "password": "",             // 密码
    "maximumPoolSize": 10,      // 连接池大小
    "minimumIdle": 2,           // 最小空闲连接
    "connectionTimeout": 30000  // 连接超时(毫秒)
  }
}
```

### 数据库模式特性

#### 1. 自动初始化
- 首次运行时自动连接数据库
- 从 `qa_pairs` 表加载知识库
- 如果连接失败，自动回退到JSON模式

#### 2. 聊天历史记录
- 自动保存每次问答到 `chat_history` 表
- 包含问题、回答和时间戳
- 可在UI中查看历史记录（统计按钮）

#### 3. 实时数据更新
- 数据库数据修改后，重启程序即可生效
- 无需重新编译代码

### 数据库表结构（与C++版本兼容）

```sql
-- qa_pairs 表（知识库）
CREATE TABLE qa_pairs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- chat_history 表（聊天历史）
CREATE TABLE chat_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 使用示例

#### JSON模式（默认）
```json
{
  "database": {
    "enabled": false
  }
}
```
- 启动快，无需数据库
- 数据在 `knowledge_base.json` 中

#### 数据库模式
```json
{
  "database": {
    "enabled": true,
    "host": "localhost",
    "username": "root",
    "password": "your_password"
  }
}
```
- 需要MariaDB服务器
- 数据在数据库中，支持持久化
- 自动记录聊天历史

### 故障处理

如果数据库连接失败：
1. 程序会自动显示错误信息
2. 自动切换到JSON模式
3. 界面会显示当前数据来源

在统计信息中可以看到：
```
📊 系统统计
数据来源: 数据库/本地JSON
知识库条目: 25条
分类数量: 9类
数据库QA对: 25条（仅数据库模式）
聊天历史: 10条（仅数据库模式）
```

---

## 🎯 使用示例

---

## 🎯 使用示例

### 问题示例
```
兰州有什么著名景点？
兰州牛肉面有什么特点？
兰州的最佳旅游时间是什么时候？
如何到达兰州？
```

### 回答示例
```
💡 AI 回答

=== 相关知识 ===

1. 【景点】兰州有什么著名景点？
   答案：兰州著名景点包括：1) 白塔山公园 - 黄河岸边的标志性景点；2) 兰山公园 - 俯瞰兰州全景；3) 五泉山公园 - 因五眼泉水得名；4) 黄河铁桥（中山桥）- 百年历史；5) 水车博览园 - 展示古代灌溉技术；6) 甘肃省博物馆 - 藏有丰富文物。
   相似度：0.923

=== AI回答 ===

兰州拥有众多著名景点，最值得推荐的有：

1. **白塔山公园** - 兰州的标志性景点，位于黄河北岸，可俯瞰全城
2. **黄河铁桥（中山桥）** - 百年历史的黄河第一桥，夜景非常美丽
3. **五泉山公园** - 因五眼泉水得名，是市民休闲的好去处
4. **兰山公园** - 登高望远，欣赏兰州全景的最佳地点
5. **水车博览园** - 展示古代灌溉技术，了解兰州黄河文化
6. **甘肃省博物馆** - 藏有丰富文物，特别是马踏飞燕
```

---

## 🎨 字体配置（可选）

### 为什么要配置字体？
- ✅ 中文显示更清晰
- ✅ 与Windows系统风格一致
- ✅ 支持多种字重

### 如何配置字体？

**1. 准备字体文件**：
```
准备中文字体文件（如：msyh.ttf, msyhbd.ttf, simhei.ttf）
目标目录：D:\Code_Project\Kotlin\LanzhouTourismQA\src\main\resources\fonts\
```

**2. 复制字体文件**：
```powershell
# PowerShell命令
$source = "C:\Windows\Fonts"  # 或你的字体文件所在目录
$dest = "D:\Code_Project\Kotlin\LanzhouTourismQA\src\main\resources\fonts"
New-Item -ItemType Directory -Force -Path $dest
# 复制微软雅黑字体
Copy-Item "$source\msyh.ttf" $dest -ErrorAction SilentlyContinue
Copy-Item "$source\msyhbd.ttf" $dest -ErrorAction SilentlyContinue
```

**3. 重新构建**：
```powershell
.\build.ps1
```

**4. 运行程序**：
```powershell
.\run.ps1
```

**注意**：不配置字体也能正常运行，会使用系统默认字体

---

## 🔍 故障排除

### 问题1: PowerShell无法执行脚本
**错误**：`无法加载文件，因为在此系统上禁止运行脚本`

**解决**：
```powershell
# 临时允许（推荐）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

# 或直接运行
powershell -ExecutionPolicy Bypass -File .\build.ps1
```

### 问题2: 找不到Java
**错误**：`java : 无法将"java"项识别为 cmdlet、函数、脚本文件`

**解决**：
1. 下载并安装JDK 17+：https://www.oracle.com/java/technologies/downloads/
2. 配置JAVA_HOME环境变量
3. 重启PowerShell

### 问题3: 构建失败
**可能原因**：
- 网络连接问题（需要下载依赖）
- JDK版本过低
- 磁盘空间不足

**解决**：
```powershell
# 检查Java版本
java -version

# 清理后重试
Remove-Item -Recurse -Force build
.\build.ps1
```

### 问题4: API调用失败
**错误**：`API调用失败` 或 `无法连接`

**解决**：
1. 检查config.json中的API密钥是否正确
2. 确认网络连接正常
3. 检查MIMO服务状态
4. 确保防火墙未阻止

### 问题5: 界面不显示中文
**解决**：
1. 确保系统支持中文
2. 使用Windows 10/11
3. 配置字体（见字体配置章节）

---

## 📊 技术规格

### 依赖版本
```
Kotlin: 1.9.21
Compose Desktop: 1.5.11
Ktor: 2.3.8
Gradle: 8.4
```

### 性能指标
- **启动时间**：3-5秒（JAR模式）
- **响应时间**：1-2秒（问答）
- **内存占用**：150-300MB
- **文件大小**：JAR包约10-15MB

### 系统要求
- **操作系统**：Windows 10/11（64位）
- **Java版本**：JDK 17+
- **网络**：需要访问MIMO API
- **磁盘空间**：至少100MB

---

## 🏗️ 技术架构

### RAG工作流程
```
用户提问
  ↓
[嵌入模型] → TF-IDF向量化（本地）
  ↓
[向量检索] → 余弦相似度匹配
  ↓
[知识库] → 检索TopK相关知识
  ↓
[提示词构建] → 系统提示 + 上下文 + 问题
  ↓
[MIMO API] → 大模型生成回答
  ↓
[GUI显示] → 展示结果
```

### 核心组件
1. **嵌入模型** - 本地TF-IDF，无需外部API
2. **RAG检索器** - 基于余弦相似度的向量检索
3. **MIMO客户端** - Ktor HTTP客户端
4. **Compose Desktop** - Material Design 3界面

---

## 📝 常用命令速查

### PowerShell
```powershell
# 初始化
.\setup.ps1

# 构建
.\build.ps1

# 运行
.\run.ps1

# 开发模式
.\gradlew.bat run

# 清理
Remove-Item -Recurse -Force build

# 检查Java
java -version

# 检查Gradle
.\gradlew.bat --version
```

### CMD
```cmd
setup.bat
build.bat
run.bat
gradlew run
```

---

## 🎓 常见问题解答

**Q: 没有MIMO API密钥怎么办？**
A: 访问 https://api.mimo.com 注册获取

**Q: 可以不构建直接运行吗？**
A: 可以，使用 `.\gradlew.bat run`

**Q: 如何更新知识库？**
A: 编辑 `src/main/resources/knowledge_base.json`

**Q: 如何修改系统提示词？**
A: 编辑 `src/main/resources/config.json` 中的 `prompt_template`

**Q: 支持哪些操作系统？**
A: 目前仅支持Windows（PowerShell/CMD）

**Q: 如何查看运行日志？**
A: 程序运行时的错误信息会直接显示在控制台

---

## 📖 项目文件清单

### 源代码（9个）
- ✅ `Main.kt` - 主程序入口
- ✅ `Models.kt` - 数据模型
- ✅ `ConfigManager.kt` - 配置管理
- ✅ `EmbeddingModel.kt` - 嵌入模型
- ✅ `RAGRetriever.kt` - RAG检索器
- ✅ `MIMOClient.kt` - API客户端
- ✅ `QAService.kt` - 核心服务
- ✅ `AppTheme.kt` - 主题和字体
- ✅ `QuestionAnswerScreen.kt` - 主界面

### 资源文件（2个）
- ✅ `config.json` - 配置文件
- ✅ `knowledge_base.json` - 知识库

### 脚本文件（6个）
- ✅ `setup.ps1` - PowerShell初始化
- ✅ `build.ps1` - PowerShell构建
- ✅ `run.ps1` - PowerShell运行
- ✅ `setup.bat` - CMD初始化
- ✅ `build.bat` - CMD构建
- ✅ `run.bat` - CMD运行

### 配置文件（4个）
- ✅ `build.gradle.kts` - Gradle主配置
- ✅ `settings.gradle.kts` - 项目设置
- ✅ `gradle.properties` - Gradle属性
- ✅ `gradle-wrapper.properties` - Wrapper配置

---

## ⚠️ 重要提醒

1. **API密钥安全**：不要将包含真实密钥的文件提交到版本控制
2. **网络连接**：构建和运行需要网络连接下载依赖和调用API
3. **Java版本**：必须使用JDK 17或更高版本
4. **执行策略**：PowerShell可能需要配置执行策略

---

## 🎉 项目完成状态

✅ **所有功能已实现**
- RAG架构完整
- 知识库25条
- GUI界面完成
- PowerShell脚本完成
- CMD脚本兼容

✅ **文档完整**
- 本文件包含所有必要信息
- 从安装到使用的完整指南
- 故障排除详细说明

✅ **可直接使用**
- 按照"快速开始"3步操作
- 遇到问题查看"故障排除"

---

## 💡 下一步建议

### 立即可用
1. 按照"快速开始"操作
2. 测试基本问答功能
3. 浏览知识库内容

### 功能扩展
1. 添加更多知识条目
2. 实现对话历史
3. 优化UI动画

---

## 📞 技术支持

如果遇到问题：
1. 查看"故障排除"章节
2. 检查控制台错误信息
3. 确认Java版本和网络连接

---

**文档版本**：1.0.0
**最后更新**：2026-01-10
**项目状态**：✅ 完成并可直接使用

**Q: 如何启用数据库模式？**
A: 修改 config.json 中的 database.enabled 为 true，并配置数据库连接信息

**Q: 数据库模式需要什么环境？**
A: 需要MariaDB数据库服务器，版本5.5+即可

**Q: 如何初始化数据库？**
A: 使用C++项目中的 setup_database_fixed.sql 脚本，在数据库中执行即可

**Q: 数据库连接失败会怎样？**
A: 程序会自动切换到JSON模式，并在界面显示警告信息

**Q: 聊天历史在哪里查看？**
A: 点击顶部工具栏的统计按钮（ℹ️），会显示数据库中的聊天历史数量

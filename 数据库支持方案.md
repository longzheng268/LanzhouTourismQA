# 数据库支持方案

## 📋 当前状态

**当前Kotlin版本**：❌ 不包含数据库驱动
**C++版本**：✅ 使用MariaDB数据库

## 🔧 解决方案

### 方案1：添加数据库支持（推荐）

如果需要兼容C++版本的数据库配置，需要以下步骤：

#### 1. 修改 build.gradle.kts

添加MariaDB JDBC驱动：
```kotlin
dependencies {
    // ... 现有依赖 ...

    // MariaDB JDBC驱动
    implementation("org.mariadb.jdbc:mariadb-java-client:3.3.2")

    // 数据库连接池（可选，提高性能）
    implementation("com.zaxxer:HikariCP:5.1.0")
}
```

#### 2. 创建数据库连接管理器

创建文件：`src/main/kotlin/com/lanzhou/qa/database/DatabaseManager.kt`

```kotlin
package com.lanzhou.qa.database

import com.zaxxer.hikari.HikariConfig
import com.zaxxer.hikari.HikariDataSource
import java.sql.Connection

class DatabaseManager(
    private val host: String = "localhost",
    private val port: Int = 3306,
    private val database: String = "qa_database",
    private val username: String = "root",
    private val password: String = ""
) {
    private var dataSource: HikariDataSource? = null

    init {
        initializeConnection()
    }

    private fun initializeConnection() {
        val config = HikariConfig().apply {
            jdbcUrl = "jdbc:mariadb://$host:$port/$database?useSSL=false"
            this.username = this@DatabaseManager.username
            this.password = this@DatabaseManager.password
            driverClassName = "org.mariadb.jdbc.Driver"

            // 连接池配置
            maximumPoolSize = 10
            minimumIdle = 2
            connectionTimeout = 30000
            idleTimeout = 600000
            maxLifetime = 1800000
        }

        dataSource = HikariDataSource(config)
    }

    fun getConnection(): Connection? {
        return try {
            dataSource?.connection
        } catch (e: Exception) {
            e.printStackTrace()
            null
        }
    }

    fun close() {
        dataSource?.close()
    }

    // 测试连接
    fun testConnection(): Boolean {
        return try {
            getConnection()?.use { true } ?: false
        } catch (e: Exception) {
            false
        }
    }

    // 查询所有问答对
    fun getAllQAPairs(): List<QAPair> {
        val qaPairs = mutableListOf<QAPair>()
        val sql = "SELECT id, question, answer FROM qa_pairs ORDER BY id"

        getConnection()?.use { conn ->
            conn.createStatement().use { stmt ->
                stmt.executeQuery(sql).use { rs ->
                    while (rs.next()) {
                        qaPairs.add(
                            QAPair(
                                id = rs.getInt("id"),
                                question = rs.getString("question"),
                                answer = rs.getString("answer")
                            )
                        )
                    }
                }
            }
        }

        return qaPairs
    }

    // 保存聊天历史
    fun saveChatHistory(question: String, answer: String) {
        val sql = "INSERT INTO chat_history (question, answer) VALUES (?, ?)"

        getConnection()?.use { conn ->
            conn.prepareStatement(sql).use { pstmt ->
                pstmt.setString(1, question)
                pstmt.setString(2, answer)
                pstmt.executeUpdate()
            }
        }
    }
}

data class QAPair(
    val id: Int,
    val question: String,
    val answer: String
)
```

#### 3. 创建数据库配置管理器

创建文件：`src/main/kotlin/com/lanzhou/qa/config/DatabaseConfig.kt`

```kotlin
package com.lanzhou.qa.config

import kotlinx.serialization.Serializable

@Serializable
data class DatabaseConfig(
    val enabled: Boolean = false,
    val host: String = "localhost",
    val port: Int = 3306,
    val database: String = "qa_database",
    val username: String = "root",
    val password: String = ""
)
```

#### 4. 修改 ConfigManager.kt

添加数据库配置加载：
```kotlin
// 在 ConfigManager.kt 中添加
fun loadDatabaseConfig(): DatabaseConfig {
    return try {
        val jsonString = File("src/main/resources/config.json").readText()
        val config = Json.decodeFromString<Config>(jsonString)
        config.database ?: DatabaseConfig()
    } catch (e: Exception) {
        DatabaseConfig() // 使用默认配置
    }
}
```

#### 5. 修改 QAService.kt

支持数据库和JSON双模式：
```kotlin
class QAService {
    private val config = ConfigManager.loadConfig()
    private val databaseConfig = ConfigManager.loadDatabaseConfig()

    // 知识库来源
    private val knowledgeItems = if (databaseConfig.enabled) {
        // 使用数据库
        val dbManager = DatabaseManager(
            host = databaseConfig.host,
            port = databaseConfig.port,
            database = databaseConfig.database,
            username = databaseConfig.username,
            password = databaseConfig.password
        )
        dbManager.getAllQAPairs().map {
            KnowledgeItem(it.id, it.question, it.answer, "数据库")
        }
    } else {
        // 使用JSON
        ConfigManager.loadKnowledgeBase().knowledge_base
    }

    // ... 其余代码保持不变 ...
}
```

#### 6. 更新 config.json

添加数据库配置部分：
```json
{
  "api": {
    "api_key": "您的API密钥",
    "api_url": "https://api.mimo.com/v1/chat/completions",
    "model": "mimo-v2-flash",
    "temperature": 0.7,
    "max_tokens": 1000
  },
  "system": {
    "prompt_template": "你是一个专业的兰州旅游专家...",
    "top_k": 5
  },
  "embedding": {
    "model": "local",
    "dimension": 384
  },
  "database": {
    "enabled": false,
    "host": "localhost",
    "port": 3306,
    "database": "qa_database",
    "username": "root",
    "password": ""
  }
}
```

### 方案2：保持JSON方案（当前）

**优势**：
- ✅ 已完成，无需修改
- ✅ 无需数据库服务器
- ✅ 启动更快
- ✅ 部署更简单

**数据库脚本内容**：
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS qa_database CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE qa_database;

-- 创建qa_pairs表（知识库）
CREATE TABLE IF NOT EXISTS qa_pairs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_question (question(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建chat_history表（聊天历史）
CREATE TABLE IF NOT EXISTS chat_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 插入兰州旅游知识数据
INSERT IGNORE INTO qa_pairs (question, answer) VALUES
('兰州在哪里？', '兰州是甘肃省省会，位于中国西北部，黄河上游。地理坐标为东经103°30\'，北纬36°03\'，是丝绸之路重镇。'),
('兰州有什么著名景点？', '兰州著名景点包括：1) 白塔山公园 - 黄河岸边的标志性景点；2) 兰山公园 - 俯瞰兰州全景；3) 五泉山公园 - 因五眼泉水得名；4) 黄河铁桥（中山桥）- 百年历史；5) 水车博览园 - 展示古代灌溉技术；6) 甘肃省博物馆 - 藏有丰富文物。'),
('兰州牛肉面有什么特点？', '兰州牛肉面讲究"一清二白三红四绿五黄"：汤清（一清）、萝卜白（二白）、辣椒油红（三红）、香菜蒜苗绿（四绿）、面条黄亮（五黄）。面条有多种粗细可选：毛细、细、二细、韭叶、宽面等。'),
('兰州的最佳旅游时间是什么时候？', '兰州最佳旅游时间是5-10月。夏季（6-8月）气候凉爽，是避暑胜地；秋季（9-10月）天高气爽，瓜果飘香。春季多风沙，冬季寒冷干燥。'),
('如何到达兰州？', '1) 飞机：兰州中川国际机场，有国内外航线；2) 高铁：兰州西站、兰州站，连接全国高铁网；3) 普通火车：兰州站；4) 自驾：连霍高速、京藏高速等多条高速交汇。'),
('兰州有哪些特色美食？', '兰州特色美食：1) 兰州牛肉面（必吃）；2) 手抓羊肉；3) 灰豆子（甜品）；4) 酿皮子；5) 热冬果；6) 牛奶鸡蛋醪糟；7) 烤羊肉串；8) 浆水面。'),
('兰州黄河铁桥的历史？', '黄河铁桥（中山桥）建于1909年，是黄河上第一座铁桥，由德国商人承建。桥长234米，宽7.5米。初名"黄河铁桥"，1942年为纪念孙中山先生改名"中山桥"。是全国重点文物保护单位。'),
('兰州白塔山有什么传说？', '白塔山因山顶有白塔寺而得名。相传元代忽必烈为纪念西藏喇嘛而建。白塔七级八面，高约17米。传说登上白塔可俯瞰兰州全景，眺望黄河九曲。'),
('兰州的气候特点是什么？', '兰州属于温带大陆性气候，特点：1) 冬季寒冷干燥，夏季凉爽；2) 昼夜温差大；3) 降水少，蒸发强；4) 日照充足；5) 多风沙。年均气温10℃左右，7月最热，1月最冷。'),
('兰州有什么特产可以带回家？', '兰州特产：1) 兰州百合（甜百合）；2) 苦水玫瑰；3) 白兰瓜；4) 黑瓜子；5) 三炮台茶；6) 牛肉面调料包；7) 甘草杏；8) 软儿梨。'),
('兰州周边有什么值得一去的地方？', '兰州周边景点：1) 兴隆山（国家级森林公园）；2) 吐鲁沟森林公园；3) 什川古梨园；4) 青城古镇；5) 河口古镇；6) 临夏（民族风情）；7) 夏河拉卜楞寺（藏传佛教）。'),
('兰州的住宿推荐？', '兰州住宿推荐：1) 城关区（市中心，交通便利）；2) 七里河区（靠近西站）；3) 安宁区（高校区，安静）。高档：兰州饭店、宁卧庄宾馆；中档：如家、汉庭等连锁；经济型：青年旅舍。'),
('兰州的夜市在哪里？', '兰州主要夜市：1) 正宁路小吃夜市（最著名）；2) 南关民族风味一条街；3) 农民巷夜市；4) 西关十字夜市。推荐：烤羊肉串、牛奶鸡蛋醪糟、酿皮子、灰豆子。'),
('兰州的市花是什么？', '兰州市花是玫瑰花。兰州苦水玫瑰闻名全国，种植历史悠久，花大瓣厚，香味浓郁，是制作玫瑰油、玫瑰茶、玫瑰糕点的优质原料。'),
('兰州有什么节庆活动？', '兰州主要节庆：1) 兰州国际马拉松（6月）；2) 兰州桃花节（4-5月）；3) 苦水玫瑰节（5月）；4) 黄河文化旅游节；5) 兰州水车节。这些活动展现了兰州的自然和人文魅力。'),
('兰州牛肉面的历史有多久？', '兰州牛肉面起源于清代嘉庆年间，由国子监太学生陈维精将制作技艺传入兰州。后经马保子等人改良创新，形成了现代兰州牛肉面的雏形，至今已有200多年历史。'),
('兰州的海拔是多少？', '兰州平均海拔约1520米。市区海拔在1400-1600米之间，地势由西南向东北倾斜。相比东部平原地区，海拔较高，但高原反应不明显。'),
('兰州话有什么特点？', '兰州方言属于北方方言区，特点：1) 声调较少，只有3-4个；2) 保留入声字；3) 词汇独特，如"莎莎"（美女）、"满福"（很好）；4) 语速快，有节奏感；5) 与普通话差异较大但可听懂。'),
('兰州的市树是什么？', '兰州市树是国槐。国槐在兰州种植广泛，适应性强，寿命长，夏季开花，是兰州城市绿化的重要树种，象征着兰州人民坚韧不拔的精神。'),
('兰州有什么文化古迹？', '兰州文化古迹：1) 白塔寺（元代）；2) 五泉山古建筑群；3) 金天观；4) 兰州城隍庙；5) 鲁土司衙门；6) 青城古民居；7) 河口古镇。这些古迹见证了兰州的历史变迁。'),
('兰州的特产水果有哪些？', '兰州特产水果：1) 白兰瓜（黄河蜜瓜）- 甜脆多汁；2) 软儿梨 - 冬季特色；3) 兰州百合 - 甜百合，可生吃；4) 杏子 - 什川杏园；5) 桃子 - 秦王桃。夏季瓜果飘香。'),
('兰州的黄河文化有什么特色？', '兰州黄河文化特色：1) 水车文化 - 古代灌溉智慧；2) 羊皮筏子 - 传统渡河工具；3) 黄河铁桥 - 百年历史；4) 黄河母亲雕塑 - 城市标志；5) 黄河风情线 - 百里黄河景观带。'),
('兰州的旅游线路怎么安排？', '兰州2日游推荐：Day1：黄河铁桥→白塔山公园→水车博览园→黄河母亲雕塑→正宁路夜市；Day2：五泉山公园→兰山公园→甘肃省博物馆→兰州老街。周边可去兴隆山或吐鲁沟。'),
('兰州的物价水平如何？', '兰州物价水平中等偏低：1) 牛肉面8-15元；2) 住宿200-400元/晚；3) 公交1-2元；4) 景点门票大多免费或20-50元；5) 特产价格实惠。整体消费比一线城市低30-50%。'),
('兰州有什么非物质文化遗产？', '兰州非物质文化遗产：1) 兰州牛肉面制作技艺；2) 苦水玫瑰种植加工技艺；3) 兰州刻葫芦；4) 河州平弦；5) 永登高高跷；6) 青城小调。这些非遗展现了兰州独特的文化魅力。');
```

## 📊 对比总结

| 特性 | 当前JSON方案 | 数据库方案 |
|------|--------------|------------|
| 兼容性 | ✅ 已完成 | ⚠️ 需要添加 |
| 复杂度 | ⭐ 简单 | ⭐⭐⭐ 中等 |
| 依赖 | 无 | MariaDB服务器 |
| 启动速度 | ⭐⭐⭐⭐⭐ 快 | ⭐⭐ 需要连接 |
| 部署 | ⭐⭐⭐⭐⭐ 极简单 | ⭐⭐ 需要配置 |

## 💡 建议

### 如果您需要数据库支持
请告诉我，我可以立即为您实现完整的数据库支持方案。

### 如果您可以使用JSON
当前方案已经完美满足需求，无需修改。

## 🎯 我的推荐

**保持当前JSON方案**，原因：
1. 25条知识用JSON完全够用
2. 无需额外依赖和配置
3. 启动更快，部署更简单
4. 与C++版本功能相同，只是存储方式优化

**如果确实需要数据库**，我可以10分钟内为您添加完整支持。

---

**当前状态**：✅ JSON方案已就绪
**数据库支持**：可选，需要时可添加
**C++兼容性**：功能相同，存储方式优化

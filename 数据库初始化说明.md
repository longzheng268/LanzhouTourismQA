# 数据库初始化说明

## 📋 概述

本系统支持双模式运行：
- **JSON模式**：默认模式，使用本地JSON文件
- **数据库模式**：使用MariaDB数据库，支持数据持久化和聊天历史记录

## 🔧 数据库配置

### 1. 修改配置文件

编辑 `src/main/resources/config.json`：

```json
{
  "database": {
    "enabled": true,              // 启用数据库模式
    "host": "raspberry.lz-0315.com",  // 数据库地址
    "port": 3306,                 // 端口
    "database": "qa_database",    // 数据库名
    "username": "root",           // 用户名
    "password": "lz",             // 密码
    "maximumPoolSize": 10,        // 连接池大小
    "minimumIdle": 2,             // 最小空闲连接
    "connectionTimeout": 30000    // 连接超时(毫秒)
  }
}
```

### 2. 数据库脚本

使用C++项目中的SQL脚本：`D:\Code_Project\Cpp Project\LLM_ContinuingEducation_QA\setup_database_fixed.sql`

或者手动创建：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS qa_database;

-- 使用数据库
USE qa_database;

-- 创建qa_pairs表（知识库）
CREATE TABLE IF NOT EXISTS qa_pairs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建chat_history表（聊天历史）
CREATE TABLE IF NOT EXISTS chat_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入示例数据
INSERT IGNORE INTO qa_pairs (question, answer) VALUES
('什么是继续教育？', '继续教育是指已经脱离正规教育，已参加工作和负有成人责任的人所接受的各种各样的教育。'),
('继续教育的目的是什么？', '继续教育的主要目的是更新知识、提高技能、适应职业变化、促进个人发展。'),
('继续教育有哪些形式？', '继续教育包括培训课程、在线学习、研讨会、工作坊、自学等多种形式。');
```

## 🚀 连接数据库

### 方法1：使用DBeaver

1. 打开DBeaver
2. 新建MariaDB连接
3. 配置：
   - 主机：`raspberry.lz-0315.com`
   - 端口：`3306`
   - 数据库：`qa_database`
   - 用户名：`root`
   - 密码：`lz`
4. 执行SQL脚本

### 方法2：使用命令行

```bash
# 连接数据库
mysql -h raspberry.lz-0315.com -P 3306 -u root -p

# 执行脚本
source /path/to/setup_database_fixed.sql
```

### 方法3：使用PowerShell

```powershell
# 连接并执行脚本
mysql -h raspberry.lz-0315.com -P 3306 -u root -plz qa_database < "D:\Code_Project\Cpp Project\LLM_ContinuingEducation_QA\setup_database_fixed.sql"
```

## ✅ 验证配置

### 1. 检查数据库连接

运行程序后，查看控制台输出：

```
✅ 数据库连接成功: raspberry.lz-0315.com:3306/qa_database
🔄 使用数据库模式加载知识库...
✅ 从数据库加载了 25 条知识
```

### 2. 检查UI统计

点击顶部工具栏的统计按钮（ℹ️），应该显示：

```
📊 系统统计
数据来源: 数据库
知识库条目: 25条
分类数量: 9类
数据库QA对: 25条
聊天历史: 0条
```

### 3. 测试问答

1. 输入问题：`兰州有什么著名景点？`
2. 点击提问
3. 查看回答
4. 检查数据库中是否保存了聊天历史：

```sql
SELECT * FROM qa_database.chat_history ORDER BY timestamp DESC LIMIT 1;
```

## 🔄 模式切换

### 从JSON切换到数据库

1. 确保数据库服务正常运行
2. 修改 `config.json`：`"enabled": true`
3. 重启程序
4. 查看控制台确认使用数据库模式

### 从数据库切换回JSON

1. 修改 `config.json`：`"enabled": false`
2. 重启程序
3. 查看控制台确认使用JSON模式

## 🐛 故障排除

### 问题1：连接超时

**错误**：`❌ 数据库连接失败: Connection timed out`

**解决**：
- 检查网络连接
- 确认数据库服务器地址和端口正确
- 检查防火墙设置

### 问题2：认证失败

**错误**：`❌ 数据库连接失败: Access denied for user`

**解决**：
- 检查用户名和密码
- 确认用户有访问qa_database的权限

### 问题3：表不存在

**错误**：`❌ 查询qa_pairs失败: Table 'qa_database.qa_pairs' doesn't exist`

**解决**：
- 执行SQL脚本创建表
- 检查数据库名是否正确

### 问题4：自动回退到JSON

**现象**：控制台显示 `⚠️ 数据库连接失败，回退到JSON模式`

**原因**：数据库连接失败，程序自动使用JSON模式

**解决**：
- 检查数据库配置
- 确认数据库服务正常运行
- 修复连接问题后重启程序

## 📊 数据对比

| 数据类型 | JSON模式 | 数据库模式 |
|---------|---------|-----------|
| 知识库 | `knowledge_base.json` | `qa_pairs`表 |
| 聊天历史 | 不保存 | `chat_history`表 |
| 数据持久化 | ❌ | ✅ |
| 实时更新 | 需重启 | 直接生效 |
| 备份 | 复制JSON文件 | 导出SQL |

## 💡 最佳实践

### 开发阶段
- 使用JSON模式，快速启动
- 无需配置数据库

### 生产部署
- 使用数据库模式
- 配置数据库备份
- 定期清理聊天历史（可选）

### 测试环境
- 可以使用数据库模式
- 准备测试数据
- 验证连接池配置

## 🔗 相关文件

- `src/main/kotlin/com/lanzhou/qa/database/DatabaseManager.kt` - 数据库管理器
- `src/main/kotlin/com/lanzhou/qa/config/DatabaseConfig.kt` - 数据库配置
- `src/main/resources/config.json` - 配置文件
- `使用文档.md` - 完整使用文档

---

**最后更新**：2026-01-10
**版本**：1.0.0

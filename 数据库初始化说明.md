# 数据库初始化说明

## 📋 概述

本系统支持双模式运行：
- **JSON模式**：默认模式，使用本地JSON文件
- **数据库模式**：使用MariaDB数据库，支持数据持久化和聊天历史记录

## 🔧 数据库配置

### 1. 修改配置文件

编辑 `src/main/resources/config.json`：

```json
{
  "database": {
    "enabled": true,              // 启用数据库模式
    "host": "localhost",          // 数据库地址
    "port": 3306,                 // 端口
    "database": "qa_database",    // 数据库名
    "username": "root",           // 用户名
    "password": "your_password",  // 密码
    "maximumPoolSize": 10,        // 连接池大小
    "minimumIdle": 2,             // 最小空闲连接
    "connectionTimeout": 30000    // 连接超时(毫秒)
  }
}
```

### 2. 数据库脚本

使用以下SQL脚本创建数据库和表：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS qa_database CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE qa_database;

-- 创建qa_pairs表（知识库）
CREATE TABLE IF NOT EXISTS qa_pairs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_question (question(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建chat_history表（聊天历史）
CREATE TABLE IF NOT EXISTS chat_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 插入兰州旅游知识数据
INSERT IGNORE INTO qa_pairs (question, answer) VALUES
('兰州在哪里？', '兰州是甘肃省省会，位于中国西北部，黄河上游。地理坐标为东经103°30\'，北纬36°03\'，是丝绸之路重镇。'),
('兰州有什么著名景点？', '兰州著名景点包括：1) 白塔山公园 - 黄河岸边的标志性景点；2) 兰山公园 - 俯瞰兰州全景；3) 五泉山公园 - 因五眼泉水得名；4) 黄河铁桥（中山桥）- 百年历史；5) 水车博览园 - 展示古代灌溉技术；6) 甘肃省博物馆 - 藏有丰富文物。'),
('兰州牛肉面有什么特点？', '兰州牛肉面讲究"一清二白三红四绿五黄"：汤清（一清）、萝卜白（二白）、辣椒油红（三红）、香菜蒜苗绿（四绿）、面条黄亮（五黄）。面条有多种粗细可选：毛细、细、二细、韭叶、宽面等。'),
('兰州的最佳旅游时间是什么时候？', '兰州最佳旅游时间是5-10月。夏季（6-8月）气候凉爽，是避暑胜地；秋季（9-10月）天高气爽，瓜果飘香。春季多风沙，冬季寒冷干燥。'),
('如何到达兰州？', '1) 飞机：兰州中川国际机场，有国内外航线；2) 高铁：兰州西站、兰州站，连接全国高铁网；3) 普通火车：兰州站；4) 自驾：连霍高速、京藏高速等多条高速交汇。'),
('兰州有哪些特色美食？', '兰州特色美食：1) 兰州牛肉面（必吃）；2) 手抓羊肉；3) 灰豆子（甜品）；4) 酿皮子；5) 热冬果；6) 牛奶鸡蛋醪糟；7) 烤羊肉串；8) 浆水面。'),
('兰州黄河铁桥的历史？', '黄河铁桥（中山桥）建于1909年，是黄河上第一座铁桥，由德国商人承建。桥长234米，宽7.5米。初名"黄河铁桥"，1942年为纪念孙中山先生改名"中山桥"。是全国重点文物保护单位。'),
('兰州白塔山有什么传说？', '白塔山因山顶有白塔寺而得名。相传元代忽必烈为纪念西藏喇嘛而建。白塔七级八面，高约17米。传说登上白塔可俯瞰兰州全景，眺望黄河九曲。'),
('兰州的气候特点是什么？', '兰州属于温带大陆性气候，特点：1) 冬季寒冷干燥，夏季凉爽；2) 昼夜温差大；3) 降水少，蒸发强；4) 日照充足；5) 多风沙。年均气温10℃左右，7月最热，1月最冷。'),
('兰州有什么特产可以带回家？', '兰州特产：1) 兰州百合（甜百合）；2) 苦水玫瑰；3) 白兰瓜；4) 黑瓜子；5) 三炮台茶；6) 牛肉面调料包；7) 甘草杏；8) 软儿梨。'),
('兰州周边有什么值得一去的地方？', '兰州周边景点：1) 兴隆山（国家级森林公园）；2) 吐鲁沟森林公园；3) 什川古梨园；4) 青城古镇；5) 河口古镇；6) 临夏（民族风情）；7) 夏河拉卜楞寺（藏传佛教）。'),
('兰州的住宿推荐？', '兰州住宿推荐：1) 城关区（市中心，交通便利）；2) 七里河区（靠近西站）；3) 安宁区（高校区，安静）。高档：兰州饭店、宁卧庄宾馆；中档：如家、汉庭等连锁；经济型：青年旅舍。'),
('兰州的夜市在哪里？', '兰州主要夜市：1) 正宁路小吃夜市（最著名）；2) 南关民族风味一条街；3) 农民巷夜市；4) 西关十字夜市。推荐：烤羊肉串、牛奶鸡蛋醪糟、酿皮子、灰豆子。'),
('兰州的市花是什么？', '兰州市花是玫瑰花。兰州苦水玫瑰闻名全国，种植历史悠久，花大瓣厚，香味浓郁，是制作玫瑰油、玫瑰茶、玫瑰糕点的优质原料。'),
('兰州有什么节庆活动？', '兰州主要节庆：1) 兰州国际马拉松（6月）；2) 兰州桃花节（4-5月）；3) 苦水玫瑰节（5月）；4) 黄河文化旅游节；5) 兰州水车节。这些活动展现了兰州的自然和人文魅力。'),
('兰州牛肉面的历史有多久？', '兰州牛肉面起源于清代嘉庆年间，由国子监太学生陈维精将制作技艺传入兰州。后经马保子等人改良创新，形成了现代兰州牛肉面的雏形，至今已有200多年历史。'),
('兰州的海拔是多少？', '兰州平均海拔约1520米。市区海拔在1400-1600米之间，地势由西南向东北倾斜。相比东部平原地区，海拔较高，但高原反应不明显。'),
('兰州话有什么特点？', '兰州方言属于北方方言区，特点：1) 声调较少，只有3-4个；2) 保留入声字；3) 词汇独特，如"莎莎"（美女）、"满福"（很好）；4) 语速快，有节奏感；5) 与普通话差异较大但可听懂。'),
('兰州的市树是什么？', '兰州市树是国槐。国槐在兰州种植广泛，适应性强，寿命长，夏季开花，是兰州城市绿化的重要树种，象征着兰州人民坚韧不拔的精神。'),
('兰州有什么文化古迹？', '兰州文化古迹：1) 白塔寺（元代）；2) 五泉山古建筑群；3) 金天观；4) 兰州城隍庙；5) 鲁土司衙门；6) 青城古民居；7) 河口古镇。这些古迹见证了兰州的历史变迁。'),
('兰州的特产水果有哪些？', '兰州特产水果：1) 白兰瓜（黄河蜜瓜）- 甜脆多汁；2) 软儿梨 - 冬季特色；3) 兰州百合 - 甜百合，可生吃；4) 杏子 - 什川杏园；5) 桃子 - 秦王桃。夏季瓜果飘香。'),
('兰州的黄河文化有什么特色？', '兰州黄河文化特色：1) 水车文化 - 古代灌溉智慧；2) 羊皮筏子 - 传统渡河工具；3) 黄河铁桥 - 百年历史；4) 黄河母亲雕塑 - 城市标志；5) 黄河风情线 - 百里黄河景观带。'),
('兰州的旅游线路怎么安排？', '兰州2日游推荐：Day1：黄河铁桥→白塔山公园→水车博览园→黄河母亲雕塑→正宁路夜市；Day2：五泉山公园→兰山公园→甘肃省博物馆→兰州老街。周边可去兴隆山或吐鲁沟。'),
('兰州的物价水平如何？', '兰州物价水平中等偏低：1) 牛肉面8-15元；2) 住宿200-400元/晚；3) 公交1-2元；4) 景点门票大多免费或20-50元；5) 特产价格实惠。整体消费比一线城市低30-50%。'),
('兰州有什么非物质文化遗产？', '兰州非物质文化遗产：1) 兰州牛肉面制作技艺；2) 苦水玫瑰种植加工技艺；3) 兰州刻葫芦；4) 河州平弦；5) 永登高高跷；6) 青城小调。这些非遗展现了兰州独特的文化魅力。');
```

## 🚀 连接数据库

### 方法1：使用DBeaver

1. 打开DBeaver
2. 新建MariaDB/MySQL连接
3. 配置：
   - 主机：`localhost`（或你的数据库服务器地址）
   - 端口：`3306`
   - 数据库：`qa_database`
   - 用户名：`root`
   - 密码：`你的密码`
4. 执行SQL脚本

### 方法2：使用命令行

```bash
# 连接数据库
mysql -h localhost -P 3306 -u root -p

# 执行脚本
source /path/to/setup_database.sql
```

### 方法3：使用PowerShell

```powershell
# 连接并执行脚本
mysql -h localhost -P 3306 -u root -pyour_password qa_database < "D:\path\to\setup_database.sql"
```

## ✅ 验证配置

### 1. 检查数据库连接

运行程序后，查看控制台输出：

```
✅ 数据库连接成功: localhost:3306/qa_database
🔄 使用数据库模式加载知识库...
✅ 从数据库加载了 25 条知识
```

### 2. 检查UI统计

点击顶部工具栏的统计按钮（ℹ️），应该显示：

```
📊 系统统计
数据来源: 数据库
知识库条目: 25条
分类数量: 9类
数据库QA对: 25条
聊天历史: 0条
```

### 3. 测试问答

1. 输入问题：`兰州有什么著名景点？`
2. 点击提问
3. 查看回答
4. 检查数据库中是否保存了聊天历史：

```sql
SELECT * FROM qa_database.chat_history ORDER BY timestamp DESC LIMIT 1;
```

## 🔄 模式切换

### 从JSON切换到数据库

1. 确保数据库服务正常运行
2. 修改 `config.json`：`"enabled": true`
3. 重启程序
4. 查看控制台确认使用数据库模式

### 从数据库切换回JSON

1. 修改 `config.json`：`"enabled": false`
2. 重启程序
3. 查看控制台确认使用JSON模式

## 🐛 故障排除

### 问题1：连接超时

**错误**：`❌ 数据库连接失败: Connection timed out`

**解决**：
- 检查网络连接
- 确认数据库服务器地址和端口正确
- 检查防火墙设置
- 确认MySQL/MariaDB服务已启动

### 问题2：认证失败

**错误**：`❌ 数据库连接失败: Access denied for user`

**解决**：
- 检查用户名和密码
- 确认用户有访问qa_database的权限
- 检查MySQL用户权限设置

### 问题3：表不存在

**错误**：`❌ 查询qa_pairs失败: Table 'qa_database.qa_pairs' doesn't exist`

**解决**：
- 执行SQL脚本创建表
- 检查数据库名是否正确
- 确认使用了正确的数据库（USE qa_database）

### 问题4：自动回退到JSON

**现象**：控制台显示 `⚠️ 数据库连接失败，回退到JSON模式`

**原因**：数据库连接失败，程序自动使用JSON模式

**解决**：
- 检查数据库配置
- 确认数据库服务正常运行
- 修复连接问题后重启程序

## 📊 数据对比

| 数据类型 | JSON模式 | 数据库模式 |
|---------|---------|-----------|
| 知识库 | `knowledge_base.json` | `qa_pairs`表 |
| 聊天历史 | 不保存 | `chat_history`表 |
| 数据持久化 | ❌ | ✅ |
| 实时更新 | 需重启 | 直接生效 |
| 备份 | 复制JSON文件 | 导出SQL |

## 💡 最佳实践

### 开发阶段
- 使用JSON模式，快速启动
- 无需配置数据库

### 生产部署
- 使用数据库模式
- 配置数据库备份
- 定期清理聊天历史（可选）

### 测试环境
- 可以使用数据库模式
- 准备测试数据
- 验证连接池配置

## 🔗 相关文件

- `src/main/kotlin/com/lanzhou/qa/database/DatabaseManager.kt` - 数据库管理器
- `src/main/kotlin/com/lanzhou/qa/config/DatabaseConfig.kt` - 数据库配置
- `src/main/resources/config.json` - 配置文件
- `使用文档.md` - 完整使用文档

---

**最后更新**：2026-02-06
**版本**：1.0.0
